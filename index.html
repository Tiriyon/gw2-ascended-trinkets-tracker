<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GW2 Ascended Trinkets Tracker</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>GW2 Ascended Trinkets Tracker</h1>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="api-token-label">Enter your API token:</span>
            </div>
            <input type="text" class="form-control" id="api-token" aria-label="API Token" aria-describedby="api-token-label">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" onclick="fetchWalletInfo()">Load Wallet Info</button>
            </div>
        </div>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <label class="input-group-text" for="prefix-filter">Filter by Prefix:</label>
            </div>
            <select class="custom-select" id="prefix-filter">
                <option selected>Choose...</option>
                <!-- Options will be added dynamically -->
            </select>
        </div>

        <div id="items-table"></div>
        <h2>Recommended Items</h2>
        <div id="recommended-items-table"></div>


    </div>
<script>
    let wallet = {};
    let materials = {};
    let bankItems = {};

    async function fetchWalletInfo() {
        const apiKey = document.getElementById("api-token").value;
        const walletResponse = await fetch(`https://api.guildwars2.com/v2/account/wallet?access_token=${apiKey}`);
        wallet = await walletResponse.json();
        const materialsResponse = await fetch(`https://api.guildwars2.com/v2/account/materials?access_token=${apiKey}`);
        materials = await materialsResponse.json();
        const bankResponse = await fetch(`https://api.guildwars2.com/v2/account/bank?access_token=${apiKey}`);
        bankItems = await bankResponse.json();

        loadItems();
    }

    async function loadItems() {
        const response = await fetch("items.json");
        const data = await response.json();

        let allPrefixes = new Set();
        let fetchPromises = [];

        for (const item of data.items) {
            const fetchPromise = fetch(`https://api.guildwars2.com/v2/items/${item.id}`)
                .then(response => response.json())
                .then(itemDetails => {
                    if (itemDetails.details && itemDetails.details.infix_upgrade && itemDetails.details.infix_upgrade.attributes) {
                        item.prefixes = itemDetails.details.infix_upgrade.attributes.map(attr => attr.attribute).filter((value, index, self) => self.indexOf(value) === index);
                        item.prefixes.forEach(prefix => allPrefixes.add(prefix));
                    } else {
                        item.prefixes = [];
                    }
                });
            fetchPromises.push(fetchPromise);
        }

        // Wait for all fetch promises to resolve
        await Promise.all(fetchPromises);

        // Populate the filter dropdown with prefixes
        populatePrefixFilter(data.items);

        // Filter items based on the selected prefix
        const selectedPrefix = document.getElementById("prefix-filter").value;
        const filteredItems = data.items.filter(item => {
            return !selectedPrefix || (item.prefixes && item.prefixes.includes(selectedPrefix));
        });

        // Generate the items table
        let tableHtml = `
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th>Item</th>
                        <th>Type</th>
                        <th>Cost</th>
                        <th>Wallet</th>
                        <th>Wiki Link</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const item of filteredItems) {
            let costString = '';
            let walletAmount = '';
            let canAfford = true;
            let affordability = 0;
            for (const [currency, amount] of Object.entries(item.cost)) {
                const currencyInfo = data.currencies.find(c => c.name === currency) || data.inventoryItems.find(c => c.name === currency);
                if (currencyInfo) {
                    costString += `${amount} ${currency}<br>`;
                    const walletEntry = wallet.find(w => w.id === currencyInfo.id);
                    const materialEntry = materials.find(m => m.id === currencyInfo.id);
                    const bankCount = bankItems.filter(i => i && i.id === currencyInfo.id).reduce((acc, i) => acc + i.count, 0);
                    const totalAmount = (walletEntry ? walletEntry.value : 0) + (materialEntry ? materialEntry.count : 0) + bankCount;
                    walletAmount += `${totalAmount} ${currency}<br>`;
                    if (totalAmount < amount) {
                        canAfford = false;
                        affordability += totalAmount / amount;
                    }
                }
            }

            const itemDetail = item;
            const iconUrl = itemDetail ? itemDetail.icon : '';
            const wikiUrl = `https://wiki.guildwars2.com/wiki/Special:Search?search=${encodeURIComponent(item.name)}`;

            tableHtml += `
                <tr>
                    <td><img src="${iconUrl}" alt="${item.name} icon" width="32" height="32"> ${item.name}</td>
                    <td>${item.type}</td>
                    <td>${costString}</td>
                    <td>${walletAmount}</td>
                    <td><a href="${wikiUrl}" target="_blank">Wiki</a></td>
                </tr>
            `;
        }

        tableHtml += '</tbody></table>';
        document.getElementById("items-table").innerHTML = tableHtml;
    }

    function populatePrefixFilter(items) {
        const allPrefixes = new Set();
        items.forEach(item => {
            if (item.prefixes) {
                item.prefixes.forEach(prefix => allPrefixes.add(prefix));
            }
        });

        const prefixFilter = document.getElementById("prefix-filter");

        // Clear existing options (except the first "Choose..." option)
        for (let i = prefixFilter.options.length - 1; i > 0; i--) {
            prefixFilter.remove(i);
        }

        // Add unique prefixes as options
        allPrefixes.forEach(prefix => {
            const option = document.createElement("option");
            option.value = prefix;
            option.textContent = prefix;
            prefixFilter.appendChild(option);
        });
    }

    // Load items and populate prefixes when the page loads
    loadItems();
</script>


</body>


